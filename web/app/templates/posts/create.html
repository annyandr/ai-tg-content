{% extends "base.html" %}

{% block title %}Создать пост - Medical SMM Bot{% endblock %}

{% block extra_head %}
<!-- Quill.js Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Marked.js for Markdown rendering (using unpkg for better compatibility) -->
<script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
<!-- Flatpickr for date/time picker with custom format -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-plus-circle"></i> Создание нового поста</h1>
    <a href="{{ url_for('posts.list_posts') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Назад
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="create-post-form">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Основная информация</h5>
                </div>
                <div class="card-body">
                    <!-- Channel Selection -->
                    <div class="mb-3">
                        <label for="channel_id" class="form-label">Канал *</label>
                        <select class="form-select" id="channel_id" name="channel_id" required>
                            <option value="">Выберите канал...</option>
                            {% for channel in channels %}
                            <option value="{{ channel.id }}">
                                {{ channel.emoji }} {{ channel.name }} ({{ channel.specialty }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Scheduled Time -->
                    <div class="mb-3">
                        <label for="scheduled_time" class="form-label">Время публикации *</label>
                        <input type="text" class="form-control" id="scheduled_time"
                               name="scheduled_time" required readonly
                               placeholder="Выберите дату и время">
                        <input type="hidden" id="scheduled_time_iso" name="scheduled_time_iso">
                        <small class="text-muted">Формат: ДД.ММ.ГГГГ ЧЧ:ММ</small>
                    </div>

                    <!-- Photo URL -->
                    <div class="mb-3">
                        <label for="photo_url" class="form-label">URL фото (опционально)</label>
                        <input type="url" class="form-control" id="photo_url" name="photo_url"
                               placeholder="https://example.com/image.jpg">
                        <small class="text-muted">
                            ⚠️ Если текст длиннее 1024 символов, фото и текст будут отправлены отдельными сообщениями
                        </small>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Текст поста</h5>
                </div>
                <div class="card-body">
                    <!-- AI Generation -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="specialty" class="form-label">Специализация</label>
                            <select class="form-select" id="specialty" name="specialty">
                                <option value="">Выберите для AI генерации...</option>
                                {% for spec in specialties %}
                                <option value="{{ spec.key }}">{{ spec.emoji }} {{ spec.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="topic" class="form-label">Тема для AI</label>
                            <input type="text" class="form-control" id="topic"
                                   placeholder="Например: Новые рекомендации по лечению">
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="generate-btn">
                            <i class="bi bi-robot"></i> Генерировать с AI
                        </button>
                    </div>

                    <!-- Quill Editor -->
                    <div class="mb-3">
                        <label class="form-label">Текст поста *</label>
                        <div id="editor" style="height: 400px; background-color: white;"></div>
                        <input type="hidden" name="text" id="post-text">
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">Символов: <span id="char-count">0</span> / 4096</small>
                            <small class="text-muted">Редактируйте текст напрямую или используйте AI генерацию</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Создать пост
                </button>
                <a href="{{ url_for('posts.list_posts') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Отмена
                </a>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <!-- Tips -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Советы</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Выберите канал и время публикации</li>
                    <li>Используйте AI для генерации контента</li>
                    <li>Отредактируйте сгенерированный текст при необходимости</li>
                    <li>Можно добавить фото по URL</li>
                    <li>Максимальная длина текста: 4096 символов</li>
                    <li><strong>⚠️ С фото/видео:</strong> если текст >1024 символов, будет отправлен отдельно</li>
                </ul>
            </div>
        </div>

        <!-- Preview -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-eye"></i> Превью</h5>
            </div>
            <div class="card-body">
                <div id="preview" class="border rounded p-3 bg-light" style="min-height: 200px;">
                    <p class="text-muted text-center">Превью появится после ввода текста</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Quill.js -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
// Initialize Quill editor
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline'],
            ['link'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
        ]
    },
    placeholder: 'Введите текст поста или сгенерируйте с помощью AI...'
});

// Store markdown content from AI - THIS IS THE SOURCE OF TRUTH
let markdownContent = null;

// Update char count and preview
function updateCharCount() {
    // If we have markdown from AI, use it for character count
    const text = markdownContent || quill.getText();
    const charCount = text.length - (markdownContent ? 0 : 1); // -1 for trailing newline from Quill
    document.getElementById('char-count').textContent = charCount;

    // Check if photo URL is set and text is too long for caption
    const photoUrl = document.getElementById('photo_url').value;
    const charCountElem = document.getElementById('char-count');

    if (photoUrl && charCount > 1024) {
        charCountElem.style.color = '#dc3545'; // Red
        charCountElem.parentElement.innerHTML =
            `<small class="text-danger">⚠️ Символов: ${charCount} / 4096 (слишком длинно для подписи к фото, будет отправлено отдельно)</small>`;
    } else if (charCount > 4096) {
        charCountElem.style.color = '#dc3545'; // Red
    } else {
        charCountElem.style.color = ''; // Default
        charCountElem.parentElement.innerHTML =
            `<small class="text-muted">Символов: <span id="char-count">${charCount}</span> / 4096</small>`;
    }

    // Update preview
    const preview = document.getElementById('preview');
    const displayText = markdownContent || quill.getText();

    if (displayText.trim().length > 0) {
        // If we have markdown from AI, render it
        if (markdownContent) {
            console.log('Rendering markdown:', markdownContent.substring(0, 100));
            try {
                // Marked v4+ uses marked.parse() method
                if (typeof marked.parse === 'function') {
                    preview.innerHTML = marked.parse(markdownContent);
                } else if (typeof marked === 'function') {
                    preview.innerHTML = marked(markdownContent);
                } else {
                    console.error('Marked library API unknown');
                    // Show with preserved line breaks
                    preview.innerHTML = '<pre style="white-space: pre-wrap; font-family: inherit;">' + markdownContent + '</pre>';
                }
                console.log('Markdown rendered successfully');
            } catch (e) {
                console.error('Marked error:', e);
                // Fallback: show as preformatted text with line breaks
                preview.innerHTML = '<pre style="white-space: pre-wrap; font-family: inherit;">' + markdownContent + '</pre>';
            }
        } else {
            // Otherwise show Quill HTML
            preview.innerHTML = quill.root.innerHTML;
        }
    } else {
        preview.innerHTML = '<p class="text-muted text-center">Превью появится после ввода текста</p>';
        markdownContent = null;
    }
}

// Also update on photo URL change
document.getElementById('photo_url').addEventListener('input', updateCharCount);

quill.on('text-change', function(delta, oldDelta, source) {
    // If user manually edits, clear markdown (force conversion from Quill)
    if (source === 'user' && markdownContent) {
        console.log('User manually edited, will extract from Quill on submit');
        markdownContent = null;
    }
    updateCharCount();
});

// AI Generation
document.getElementById('generate-btn').addEventListener('click', async function() {
    const topic = document.getElementById('topic').value;
    const specialty = document.getElementById('specialty').value;

    if (!topic || !specialty) {
        alert('Выберите специализацию и введите тему для генерации');
        return;
    }

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Генерирую...';

    try {
        const response = await fetch('/posts/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topic, specialty })
        });

        const result = await response.json();

        if (result.error) {
            alert('Ошибка: ' + result.error);
        } else {
            console.log('AI generated content:', result.content.substring(0, 100));

            // Store markdown content - THIS IS THE SOURCE OF TRUTH
            markdownContent = result.content;

            // Insert into Quill preserving line breaks
            // Convert text to Delta format to preserve \n
            const lines = result.content.split('\n');
            const delta = { ops: [] };

            lines.forEach((line, index) => {
                delta.ops.push({ insert: line });
                // Add newline after each line except the last
                if (index < lines.length - 1) {
                    delta.ops.push({ insert: '\n' });
                }
            });

            quill.setContents(delta, 'api');

            // Force update preview (preview will show formatted markdown)
            updateCharCount();

            alert('Контент успешно сгенерирован!\n\n✅ В редакторе: текст с переносами строк\n✅ В превью: форматированная версия\n✅ Можете отредактировать при необходимости');
        }
    } catch (error) {
        alert('Ошибка генерации: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> Генерировать с AI';
    }
});

// Convert Quill HTML to simple Markdown (preserve line breaks)
function quillToMarkdown() {
    const html = quill.root.innerHTML;
    let markdown = html;

    // Convert <strong> and <b> to **text**
    markdown = markdown.replace(/<(strong|b)>(.*?)<\/(strong|b)>/gi, '**$2**');

    // Convert <em> and <i> to *text*
    markdown = markdown.replace(/<(em|i)>(.*?)<\/(em|i)>/gi, '*$2*');

    // Convert <a> to [text](url)
    markdown = markdown.replace(/<a href="([^"]+)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');

    // Convert <br> to newline
    markdown = markdown.replace(/<br\s*\/?>/gi, '\n');

    // Convert </p> to double newline
    markdown = markdown.replace(/<\/p>\s*<p>/gi, '\n\n');
    markdown = markdown.replace(/<\/p>/gi, '\n\n');
    markdown = markdown.replace(/<p[^>]*>/gi, '');

    // Remove other HTML tags
    markdown = markdown.replace(/<[^>]+>/g, '');

    // Decode HTML entities
    const txt = document.createElement('textarea');
    txt.innerHTML = markdown;
    markdown = txt.value;

    // Clean up excessive newlines
    markdown = markdown.replace(/\n{3,}/g, '\n\n');

    return markdown.trim();
}

// Form submission - send original markdown if unchanged
document.getElementById('create-post-form').addEventListener('submit', function(e) {
    let contentToSend;

    // If we have original markdown from AI, use it
    if (markdownContent) {
        contentToSend = markdownContent;
        console.log('Sending original markdown from AI');
    } else {
        // User typed manually or edited AI content - extract from Quill
        // Get plain text from Quill, but Quill.getText() removes formatting
        // So we need to get Delta and reconstruct text with line breaks
        const delta = quill.getContents();
        let text = '';

        delta.ops.forEach(op => {
            if (typeof op.insert === 'string') {
                text += op.insert;
            }
        });

        contentToSend = text.trim();
        console.log('Extracted from Quill:', contentToSend.substring(0, 100));
    }

    if (contentToSend.length === 0) {
        e.preventDefault();
        alert('Введите текст поста');
        return false;
    }

    if (contentToSend.length > 4096) {
        e.preventDefault();
        alert('Текст слишком длинный (максимум 4096 символов)');
        return false;
    }

    console.log('Final content to send:', contentToSend.substring(0, 100));
    document.getElementById('post-text').value = contentToSend;
});

// Set default scheduled time (1 hour from now) with Flatpickr
window.addEventListener('DOMContentLoaded', function() {
    // Check if marked library is loaded
    if (typeof marked === 'undefined') {
        console.error('Marked library not loaded!');
    } else {
        console.log('Marked library loaded successfully, version:', marked.version || 'unknown');
    }

    // Initialize Flatpickr for datetime picker
    const now = new Date();
    now.setHours(now.getHours() + 1);
    now.setMinutes(0);
    now.setSeconds(0);

    flatpickr("#scheduled_time", {
        enableTime: true,
        dateFormat: "d.m.Y H:i",  // Российский формат: ДД.ММ.ГГГГ ЧЧ:ММ
        time_24hr: true,           // 24-часовой формат
        locale: "ru",              // Русская локализация
        defaultDate: now,
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            // Store ISO format for backend
            if (selectedDates.length > 0) {
                document.getElementById('scheduled_time_iso').value = selectedDates[0].toISOString();
            }
        }
    });

    // Set initial ISO value
    document.getElementById('scheduled_time_iso').value = now.toISOString();
});
</script>
{% endblock %}
