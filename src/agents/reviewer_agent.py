"""
–ê–≥–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
"""

import json
from typing import Dict, Any

from src.agents.base_agent import BaseAgent
from src.core.logger import logger


REVIEWER_SYSTEM_PROMPT = """–¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∏—á–µ—Å–∫–∏–º –Ω–æ—Ä–º–∞–º.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–ø–∞—Å–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –ø—Ä–∏–∑—ã–≤–æ–≤ –∫ —Å–∞–º–æ–ª–µ—á–µ–Ω–∏—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –µ—Å—Ç—å –ø—Ä–∏–∑—ã–≤ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É (–≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–Ω ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "safe": true/false,
  "issues": ["—Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å"],
  "suggestions": ["—Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é"]
}
"""


class ReviewerAgent(BaseAgent):
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    """
    
    def get_system_prompt(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç"""
        return REVIEWER_SYSTEM_PROMPT
    
    async def execute(self, content: str) -> Dict[str, Any]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        
        Args:
            content: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
        """
        logger.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å...")
        
        user_prompt = f"""–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø–æ—Å—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

{content}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ."""
        
        result = await self.generate(
            user_prompt=user_prompt,
            temperature=0.3,
            max_tokens=500
        )
        
        if not result["success"]:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {result.get('error')}")
            return {
                "safe": True,  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
                "issues": [],
                "suggestions": []
            }
        
        try:
            review_data = json.loads(result["content"])
            
            if review_data.get("safe"):
                logger.info("‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω")
            else:
                logger.warning(f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: {review_data.get('issues')}")
            
            return review_data
        
        except json.JSONDecodeError:
            logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, —Å—á–∏—Ç–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–º")
            return {
                "safe": True,
                "issues": [],
                "suggestions": []
            }


__all__ = ["ReviewerAgent"]
